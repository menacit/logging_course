<!--
SPDX-FileCopyrightText: Â© 2024 Menacit AB <foss@menacit.se>
SPDX-License-Identifier: CC-BY-SA-4.0
X-Context: Logging course - Auditbeat collection/analysis lab
-->

# Logging course - Auditbeat collection/analysis lab

## Scenario description
Earlier this morning you heard the bossman running down the corridor screaming "PIVOT PIVOT PIVOT"!
While selling threat intelligence has been somewhat lucrative, apparently "managed detection and
response" is the name of the game. He's even sold it to a customer already - apparently they are
having some suspected insider threats that they are very keen to unravel. He forgot to mention 
that we currently don't have any such capabilities, of course.  

It's time to call your spouse and tell them that you won't be home for dinner - we have some
audit logging to implement!


## Learning objectives
Practical knowledge of using Elastic Beats to collect/ship audit logs and OpenSearch for alerting.


## Lab overview
The lab environment consist of a pre-configured server running OpenSearch, OpenSearch Dashboards
and Logstash using Docker Compose.  

In order to complete the lab, the student should install and configure the
[Auditbeat](https://www.elastic.co/beats/auditbeat) logging agent on the lab system to monitor
file/process creation. The student should also configure monitoring in OpenSearch to generate
alerts when the monitored activity occurs.  
  
A web browser and SSH client are prerequisites for lab participation.  
  
OpenSearch Dashboards can be accessed at "https://dashboard.%LAB_DOMAIN%".
In order to install Auditbeat and modify its configuration, establish a SSH connection to
"shell.%LAB_DOMAIN%". Credentials to both services should be provided by the course teacher.


## Tasks

### Mandatory ("G")
- Install Auditbeat OSS (repository already configure on lab system)
- Utilize the "file\_integrity" module in Auditbeat to recursively monitor changes in "/opt/myapp"
- Utilize "logstash" output in Auditbeat to deliver logs to 127.0.0.1 port 5044 with TLS disabled
- Ensure that the Auditbeat service is started at system boot
- Setup a monitor in OpenSearch to generate an alert when files in "/opt/myapp" are modified
  - Configure the monitor to exclude changes in "/opt/myapp/cache"


### Meritorious ("VG")
- Utilize the "auditd" module in Auditbeat to log process creation/execution
- Setup a monitor in OpenSearch to generate an alert when the "id" binary is executed
- Setup a monitor in OpenSearch to generate an alert when the "nmap" binary is executed
- Setup a composite monitor in OpenSearch for the "id" and "nmap" monitors


## Lab report/documentation
Each student should submit a lab report containing **at least** the following information ("G"):
- Commands used to install/configure Auditbeat
- Changes made to Auditbeat configuration file to complete mandatory tasks
- Configuration made in OpenSearch to enable alerting
- Screenshot or other proof of alert being triggered in OpenSearch
  
When applicable, it should describe changes performed to implement process
creation monitoring ("VG").  
  
The lab report should be provided as a plain text file (".txt"), Markdown document or PDF file.
Upload the lab report and any related files, such as a copy of the Auditbeat configuration file,
to %REPORT_TARGET%.


## Guidance and resources

### Triggering events of interest
In order to aid testing of file integrity and process monitoring, execute the following command
to simulate relevant activity on the lab system:

```
$ mock_activity_generator
```

The script performs actions of interest as several test users, which should be detectable if
appropriate configuration is in place.


### Using Filebeat for reference
An instance of the Filebeat logging should be configured and running on the student's lab system.
As the Elastic Beats share the same configuration format/general structure, its configuration file
"/etc/filebeat/filebeat.yml" may serve as useful guidance/reference.


### Reviewing agent logs
To validate the runtime status and latest internal log messages generated by Auditbeat,
execute the following command:

```
$ sudo systemctl status auditbeat.service
```


### Configuring Logstash output
An instance of Logstash is running inside a Docker container on the same lab system as Auditbeat
should be installed on. The Logstash container has an input network listener for Beats configured
and exposed via Docker port forwarding to the host network.  

This means that the Logstash receiver can be accessed from the lab system via localhost/127.0.0.1
on port 5044/TCP.


### No alert notification required
When setting up alerts in OpenSearch to complete the mandatory and/or meritorious tasks,
there is no requirement to enable external notifications (email, Slack, etc.).


### Validating configuration file
In order to validate the state of Auditbeat's configuration, execute the command below:

```
$ sudo auditbeat test config -c /etc/auditbeat/auditbeat.yml
```

As the configuration file is written in the YAML format, a standard linter utility such as
"yamllint" may be used to detected errors:

```
$ sudo yamllint /etc/auditbeat/auditbeat.yml
```


### Problems combining "file\_integrity" and "auditd" modules
In auditbeat, the "file\_integrity" and "auditd" modules can't be enabled at the same time.  
To avoid issues when completing the meritorious lab tasks, make sure to disable the
"file\_integrity" module after results have been documented. FIM functionality can also be
implemented by configuring "file system rules" in the "auditd" module configuration, but this
is not required to complete tha lab exercise.


### Links
- ["Monitors" manual](https://opensearch.org/docs/latest/observing-your-data/alerting/monitors/)
- [Elastic Docs - Auditbeat reference](https://www.elastic.co/guide/en/beats/auditbeat/current/)
- [Red Hat articles - "What is YAML?"](https://www.redhat.com/en/topics/automation/what-is-yaml)
- [Auditd manual - audit.rules](https://man7.org/linux/man-pages/man7/audit.rules.7.html)
- [Linux manual - "execve" system call](https://www.man7.org/linux/man-pages/man2/execve.2.html)
- ["Composite monitors" manual](https://opensearch.org/docs/latest/observing-your-data/alerting/composite-monitors/)
